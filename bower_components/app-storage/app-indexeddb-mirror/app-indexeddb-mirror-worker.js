!function(){"use strict";function e(e,o){e=e||"app-mirror",o=o||"mirrored_data",this[n]=e,this[r]=o,this[t]=new Array,this[s]=null,this.openDb(),self.addEventListener("unhandledrejection",function(e){console.error(e)}),self.addEventListener("error",function(e){console.error(e)}),this.supportsIndexedDB=null!=self.indexedDB,console.log("AppIndexedDBMirrorWorker started...")}var t="__clientPorts",n="__dbName",r="__storeName",s="__dbOpens",o=[function(e){e.database.createObjectStore(e.storeName)},function(e){e.database.createObjectStore("internal")}];e.prototype={openDb:function(){return this.__dbOpens=this.__dbOpens||new Promise(function(e,t){console.log("Opening database..");var s=indexedDB.open(this[n],2);s.onupgradeneeded=function(e){console.log("Upgrade needed:",e.oldVersion,"=>",e.newVersion);for(var t={database:s.result,storeName:this[r],dbName:this[n]},i=e.oldVersion;i<e.newVersion;++i)o[i]&&o[i].call(this,t)}.bind(this),s.onsuccess=function(){console.log("Database opened."),e(s.result)},s.onerror=function(){t(s.error)}}.bind(this)),this.__dbOpens},closeDb:function(){return null==this.__dbOpens?Promise.resolve():this.openDb().then(function(e){this.__dbOpens=null,console.log("Closing database.."),e.close()}.bind(this))},operateOnStore:function(e,t,n){var r=Array.from(arguments).slice(3);return this.openDb().then(function(s){return console.log("Store operation:",e,t,n,r),new Promise(function(o,i){try{var a=s.transaction(t,n),c=a.objectStore(t),d=c[e].apply(c,r)}catch(e){return i(e)}a.oncomplete=function(){o(d.result)},a.onabort=function(){i(a.error)}})})},get:function(e,t){return this.operateOnStore("get",e,"readonly",t)},set:function(e,t,n){return this.operateOnStore("put",e,"readwrite",n,t)},clear:function(e){return this.operateOnStore("clear",e,"readwrite")},transaction:function(e,t,n){switch(n=n||null,e){case"get":return this.get(this[r],t);case"set":return this.set(this[r],t,n)}return Promise.reject(new Error("Method not supported: "+e))},validateSession:function(e){return Promise.all([this.openDb(),this.get("internal","session")]).then(function(t){t[0];var n=t[1],s=[];e!==n&&(null!=n&&s.push(this.clear(this[r])),s.push(this.set("internal","session",e)))}.bind(this))},registerClient:function(e){e.addEventListener("message",function(t){this.handleClientMessage(t,e)}.bind(this)),!e in this[t]&&this[t].push(e),e.start(),e.postMessage({type:"app-mirror-connected",supportsIndexedDB:this.supportsIndexedDB}),console.log("New client connected.")},handleClientMessage:function(e,n){if(e.data){var r=e.data.id;switch(e.data.type){case"app-mirror-close-db":this.closeDb().then(function(){n.postMessage({type:"app-mirror-db-closed",id:r})});case"app-mirror-validate-session":this.validateSession(e.data.session).then(function(){n.postMessage({type:"app-mirror-session-validated",id:r})});break;case"app-mirror-transaction":this.transaction(e.data.method,e.data.key,e.data.value).then(function(e){n.postMessage({type:"app-mirror-transaction-result",id:r,result:e})});break;case"app-mirror-disconnect":var s=this[t].indexOf(n);-1!==s&&this[t].splice(s,1)}}}},self.appIndexedDBMirrorWorker=new e,self.addEventListener("connect",function(e){appIndexedDBMirrorWorker.registerClient(e.ports[0])})}();